<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spin Wheel</title>
<style>
  :root{--bg:#0f1724;--btn:#06b6d4;--text:#e6eef6}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center}
  .wrap{width:360px;max-width:92%;text-align:center;padding:20px}
  #wheelBox{position:relative;width:320px;height:320px;margin:0 auto}
  #wheel{width:100%;height:100%;border-radius:50%;display:block;transform-origin:50% 50%;will-change:transform}
  /* السهم ثابت فوق العجلة — عدّل top أو width إذا احتجت ضبط دقيق */
  #pointer{position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:48px;pointer-events:none;z-index:5}
  #spinBtn{margin-top:16px;padding:12px 18px;background:var(--btn);border:none;border-radius:10px;color:#042;font-weight:800;cursor:pointer;font-size:16px}
  #msg{margin-top:12px;font-size:15px;color:#cbd5e1}
  #countdown{margin-top:8px;color:#9fb6c6;font-size:13px}
  .disabled{opacity:0.6;pointer-events:none}
</style>
</head>
<body>
  <div class="wrap">
    <div id="wheelBox">
      <img id="wheel" src="wheel.png" alt="wheel">
      <img id="pointer" src="pointer.png" alt="pointer">
    </div>
    <button id="spinBtn">لديك تدويرة مجانية</button>
    <div id="msg"></div>
    <div id="countdown"></div>
  </div>

<script>
/*
  ملاحظة مهمة:
  - لتضمن أن قطاع HARD_LUCK يتوقف تماماً تحت السهم، اضبط قيمة HARD_LUCK_CENTER_ANGLE
    لتكون زاوية مركز قطاع HARD_LUCK في صورة wheel.png (بالدرجات، 0 عند الأعلى، تزداد مع عقارب الساعة).
  - مثال شائع لقطاع في منتصف العجلة: 225 درجة. عدّل القيمة إذا لاحظت ان القطاع لا يصطف تماماً.
*/

const tg = window.Telegram?.WebApp || null;
const user = tg?.initDataUnsafe?.user || {};
const user_id = user.id || 'guest';
const STORAGE_KEY = 'ichancy_last_spin_' + user_id;

/* زاوية مركز قطاع HARD_LUCK — عدّل هذه القيمة لتطابق صورتك */
const HARD_LUCK_CENTER_ANGLE = 225;

/* عدد القطاعات في العجلة (هنا 8) */
const SECTORS = 8;
const SECTOR_ANGLE = 360 / SECTORS;

const wheel = document.getElementById('wheel');
const spinBtn = document.getElementById('spinBtn');
const msg = document.getElementById('msg');
const countdown = document.getElementById('countdown');

let spinning = false;
let lastFinalRotation = 0;

function canSpin() {
  const last = localStorage.getItem(STORAGE_KEY);
  if (!last) return true;
  return (Date.now() - Number(last)) >= 24*3600*1000;
}

function setSpinTime() {
  localStorage.setItem(STORAGE_KEY, String(Date.now()));
  updateCountdown();
}

function updateCountdown() {
  const last = Number(localStorage.getItem(STORAGE_KEY));
  if (!last) {
    countdown.textContent = '';
    spinBtn.classList.remove('disabled');
    return;
  }
  const remainMs = 24*3600*1000 - (Date.now() - last);
  if (remainMs <= 0) {
    countdown.textContent = '';
    spinBtn.classList.remove('disabled');
    return;
  }
  spinBtn.classList.add('disabled');
  const s = Math.floor(remainMs/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  countdown.textContent = `التدويرة التالية خلال ${h}س ${m}د ${sec}ث`;
}

/* دالة الدوران: تضمن أن العجلة تتوقف دائماً بحيث يكون مركز قطاع HARD_LUCK تحت السهم */
function spinToHardLuck() {
  if (spinning) return;
  if (!canSpin()) {
    msg.textContent = 'انتظر حتى انتهاء العدّاد';
    return;
  }

  spinning = true;
  msg.textContent = 'جاري الدوران...';

  // عدد اللفات الكاملة المرئية (اجعلها كبيرة بما يكفي لتبدو عشوائية)
  const fullSpins = 6 + Math.floor(Math.random() * 3); // 6-8 لفات

  // نحسب الزاوية النهائية بحيث يقع مركز قطاع HARD_LUCK عند زاوية 0 (أعلى العجلة)
  // بما أن السهم يشير للأعلى (زاوية 0)، نحتاج تدوير العجلة بحيث تصبح زاوية مركز القطاع عند 0.
  // لذلك نأخذ (360 - HARD_LUCK_CENTER_ANGLE) كإزاحة.
  const targetOffset = (360 - HARD_LUCK_CENTER_ANGLE) % 360;

  // نضيف تصحيح بسيط لضمان أن التوقف يكون في منتصف القطاع (في حال HARD_LUCK_CENTER_ANGLE لم تكن دقيقة)
  // هذا التصحيح يمكن تغييره أو إزالته؛ هنا نتركه 0 لأن HARD_LUCK_CENTER_ANGLE يفترض أنه مركز القطاع.
  const centerCorrection = 0;

  const finalRotation = fullSpins * 360 + targetOffset + centerCorrection;

  // نحفظ الدوران النهائي لاستخدامه لاحقاً
  lastFinalRotation = finalRotation;

  // تطبيق انتقال سلس
  wheel.style.transition = 'transform 4.2s cubic-bezier(.17,.67,.12,1)';
  requestAnimationFrame(() => {
    wheel.style.transform = `rotate(${finalRotation}deg)`;
  });

  // عند انتهاء الانتقال نثبت الحالة
  wheel.addEventListener('transitionend', onStop, { once: true });

  // safety fallback
  setTimeout(() => { if (spinning) onStop(); }, 5200);
}

function onStop() {
  spinning = false;

  // نثبت الدوران النهائي بدون انتقال حتى لا يتغير عند تكرار الضغط
  // نحسب زاوية ضمن 0-360 للاحتفاظ بها
  const normalized = ((lastFinalRotation % 360) + 360) % 360;
  wheel.style.transition = 'none';
  wheel.style.transform = `rotate(${lastFinalRotation}deg)`;

  msg.textContent = 'حظ أوفر، حاول غداً';
  setSpinTime();

  // إرسال النتيجة للبوت (HARD_LUCK)
  try {
    if (tg && typeof tg.sendData === 'function') {
      tg.sendData(JSON.stringify({ prize: 'HARD_LUCK', user_id }));
    }
  } catch (e) {}

  updateCountdown();
}

/* زر الدوران */
spinBtn.addEventListener('click', () => {
  if (!canSpin()) {
    msg.textContent = 'الرجاء الانتظار حتى انتهاء العدّاد';
    return;
  }
  spinToHardLuck();
});

/* تحديث العدّاد كل ثانية */
setInterval(updateCountdown, 1000);
updateCountdown();
</script>
</body>
</html>
