<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spin Wheel</title>
<style>
  :root{--bg:#0f1724;--btn:#06b6d4;--text:#e6eef6}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center}
  .wrap{width:360px;max-width:92%;text-align:center;padding:20px}
  #wheelBox{position:relative;width:320px;height:320px;margin:0 auto}
  #wheel{width:100%;height:100%;border-radius:50%;display:block;transform-origin:50% 50%;will-change:transform}
  #pointer{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:56px;pointer-events:none;z-index:5}
  #spinBtn{margin-top:16px;padding:12px 18px;background:var(--btn);border:none;border-radius:10px;color:#042;font-weight:800;cursor:pointer;font-size:16px}
  #msg{margin-top:12px;font-size:15px;color:#cbd5e1}
  #countdown{margin-top:8px;color:#9fb6c6;font-size:13px}
  .disabled{opacity:0.6;pointer-events:none}
</style>
</head>
<body>
  <div class="wrap">
    <div id="wheelBox">
      <img id="wheel" src="wheel.png" alt="wheel">
      <img id="pointer" src="pointer.png" alt="pointer">
    </div>
    <button id="spinBtn">لديك تدويرة مجانية</button>
    <div id="msg"></div>
    <div id="countdown"></div>
  </div>

<script>
/* إعدادات */
const tg = window.Telegram?.WebApp || null;
const user = tg?.initDataUnsafe?.user || {};
const user_id = user.id || 'guest';
const STORAGE_KEY = 'ichancy_last_spin_' + user_id;

/* زاوية قطاع HARD_LUCK بالنسبة لصورتك */
const HARD_LUCK_ANGLE = 225; // عدّل إذا لاحظت ان القطاع مختلف قليلاً

/* عناصر */
const wheel = document.getElementById('wheel');
const spinBtn = document.getElementById('spinBtn');
const msg = document.getElementById('msg');
const countdown = document.getElementById('countdown');

let spinning = false;
let currentRotation = 0;

/* تحقق من إمكانية الدوران */
function canSpin() {
  const last = localStorage.getItem(STORAGE_KEY);
  if (!last) return true;
  return (Date.now() - Number(last)) >= 24*3600*1000;
}

/* حفظ وقت الدوران */
function setSpinTime() {
  localStorage.setItem(STORAGE_KEY, String(Date.now()));
  updateCountdown();
}

/* تحديث عداد 24 ساعة */
function updateCountdown() {
  const last = Number(localStorage.getItem(STORAGE_KEY));
  if (!last) {
    countdown.textContent = '';
    spinBtn.classList.remove('disabled');
    return;
  }
  const remainMs = 24*3600*1000 - (Date.now() - last);
  if (remainMs <= 0) {
    countdown.textContent = '';
    spinBtn.classList.remove('disabled');
    return;
  }
  spinBtn.classList.add('disabled');
  const s = Math.floor(remainMs/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  countdown.textContent = `التدويرة التالية خلال ${h}س ${m}د ${sec}ث`;
}

/* حركة الدوران واقعية ثم توقف على HARD_LUCK */
function spinToHardLuck() {
  if (spinning) return;
  if (!canSpin()) {
    msg.textContent = 'انتظر حتى انتهاء العدّاد';
    return;
  }
  spinning = true;
  msg.textContent = 'جاري الدوران...';
  // نضيف عدد لفات عشوائية مرئية ثم نصل للزاوية الثابتة
  const fullSpins = 5 + Math.floor(Math.random()*3); // 5-7 لفات
  // نحسب الزاوية النهائية بحيث القطاع HARD_LUCK يقع تحت السهم
  // ملاحظة: في الكود نستخدم (360 - HARD_LUCK_ANGLE) لأن السهم في الأعلى يشير لزاوية 0
  const final = fullSpins*360 + (360 - HARD_LUCK_ANGLE);
  // نستخدم انتقال CSS سلس
  wheel.style.transition = 'transform 4.2s cubic-bezier(.17,.67,.12,1)';
  // نطبق الدوران
  requestAnimationFrame(()=> {
    wheel.style.transform = `rotate(${final}deg)`;
  });
  // بعد انتهاء الانتقال
  wheel.addEventListener('transitionend', onStop, { once: true });
  // safety timeout
  setTimeout(()=>{ if (spinning) onStop(); }, 5000);
}

/* عند التوقف */
function onStop() {
  spinning = false;
  // نثبت قيمة الدوران الحالية لتجنب تراكم التحويلات
  const computed = getComputedStyle(wheel).transform;
  // لا نعتمد على المصفوفة هنا؛ نحتفظ بالزاوية النهائية كما هي
  wheel.style.transition = 'none';
  // نترك الرسالة النهائية
  msg.textContent = 'حظ أوفر، حاول غداً';
  setSpinTime();
  // إرسال النتيجة للبوت
  try {
    if (tg && typeof tg.sendData === 'function') {
      tg.sendData(JSON.stringify({ prize: 'HARD_LUCK', user_id }));
    }
  } catch(e){}
  updateCountdown();
}

/* زر الدوران */
spinBtn.addEventListener('click', () => {
  if (!canSpin()) {
    msg.textContent = 'الرجاء الانتظار حتى انتهاء العدّاد';
    return;
  }
  spinToHardLuck();
});

/* تحديث العدّاد كل ثانية */
setInterval(updateCountdown, 1000);
updateCountdown();
</script>
</body>
</html>
